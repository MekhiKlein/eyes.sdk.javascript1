name: JS Build
description: Build JS package
inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: true
  build-type:
    description: type of the build script
    type: string
  links:
    description: names of package directories to link before building
    type: string
  shell:
    description: shell to use
    type: string
    default: bash

runs:
  using: composite
  steps:
    - name: Build
      shell: ${{inputs.shell}}
      working-directory: ${{inputs.working-directory}}
      run: |
        echo "::group::Configure Yarn"
        yarn set version stable
        yarn -v
        WORKSPACE_NAME=$(jq -r .name ./package.json)
        echo "::endgroup::"

        echo "::group::Installing dependencies"
        yarn workspaces focus {root,$WORKSPACE_NAME}
        echo "::endgroup::"

        if [ -e .env ]
        then
          echo "::group::Setting environment variables"
          set -o allexport
          source .env
          set +o allexport
          echo "::endgroup::"
        fi

        echo "::group::Building package"
        yarn workspaces foreach --topological-dev --recursive --parallel --from $WORKSPACE_NAME run build
        yarn workspace $WORKSPACE_NAME run build:${{inputs.build-type}}
        echo "::endgroup::"
