name: JS Build
description: Build JS package
inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: true
  build-type:
    description: type of the build script
    type: string
  links:
    description: names of package directories to link before building
    type: string
  shell:
    description: shell to use
    type: string
    default: bash

runs:
  using: composite
  steps:
    - name: Build
      shell: ${{inputs.shell}}
      working-directory: ${{inputs.working-directory}}
      run: |
        echo "::group::Configure NPM"
        npm install --global npm@9.6.4
        npm -v
        if [ "${{runner.os}}" = "Windows" ]; then npm --prefix=/ config set script-shell "C:\\Program Files\\Git\\bin\\bash.exe"; fi
        npm --prefix=/ config set audit false
        npm --prefix=/ config set fund false
        echo "::endgroup::"

        echo "::group::Installing dependencies"
        npm --prefix=../../ ci
        echo "::endgroup::"

        if [ -e .env ]
        then
          echo "::group::Setting environment variables"
          set -o allexport
          source .env
          set +o allexport
          echo "::endgroup::"
        fi

        echo "::group::Building package"
        npm --prefix=../../ run build -- --target=$PWD --type=${{inputs.build-type}} --with-deps
        echo "::endgroup::"
