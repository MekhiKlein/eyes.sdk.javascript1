name: JS Test
description: Test JS package
inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: true
  framework-version:
    description: version of the framework
    type: string
  test-type:
    description: type of the testing (unit, it, e2e, coverage)
    type: string
  build-type:
    description: type of the build script
    type: string
  setup-type:
    description: type of the setup script
    type: string
  links:
    description: names of package directories to link before testing
    type: string
  grep:
    description: grep pattern to filter tests
    type: string
  parallel:
    description: number of parallel processes to run tests
    type: number
  report:
    description: report level
    type: string
    default: sandbox
  shell:
    description: shell to use
    type: string
    default: bash

runs:
  using: composite
  steps:
    - name: Test
      shell: ${{inputs.shell}}
      working-directory: ${{inputs.working-directory}}
      env:
        MOCHA_GREP: ${{inputs.grep}}
        MOCHA_JOBS: ${{inputs.parallel}}
        APPLITOOLS_FRAMEWORK_VERSION: ${{inputs.framework-version}}
        APPLITOOLS_FRAMEWORK_MAJOR_VERSION: ${{inputs.framework-version}}
      run: |
        echo "::group::Configure NPM"
        if [ "${{runner.os}}" = "Windows" ]; then npm config set script-shell "C:\\Program Files\\Git\\bin\\bash.exe"; fi
        npm set audit false
        npm set fund false
        echo "::endgroup::"

        echo "::group::Installing and linking dependencies"
        npm --prefix=../../ run workspace -- install --target=$PWD --link=\"${{inputs.links}}\"
        ls -F ./node_modules/@applitools
        npm run upgrade:framework --if-present
        echo "::endgroup::"

        echo "::group::Setting up test environment"
        if [ ! -z "${{inputs.setup-type}}" ]
        then
          if [ "${{inputs.setup-type}}" != "none" ]; then npm run setup:${{inputs.setup-type}}; fi
        else
          npm run setup --if-present
        fi

        if [ -e .env ]
        then
          set -o allexport
          source .env
          set +o allexport
        fi
        echo "::endgroup::"

        echo "::group::Building package"
        if [ ! -z "${{inputs.build-type}}" ]
        then
          if [ "${{inputs.build-type}}" != "none" ]; then npm run build:${{inputs.build-type}}; fi
        else
          npm run build --if-present
        fi
        echo "::endgroup::"

        echo "::group::Running tests"
        if [ ! -z "${{inputs.test-type}}" ]; then npm run test:${{inputs.test-type}}; else npm run test --if-present; fi
        echo "::endgroup::"

        echo "::group::Sending reports"
        if [ "${{inputs.report}}" = "sandbox" ]; then npm run report --if-present -- --sandbox; else npm run report --if-present; fi
        echo "::endgroup::"
