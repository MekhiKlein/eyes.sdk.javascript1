name: Ruby build
description: Build Ruby SDK Packages

inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: true
  gem-list:
    description: optional filter
    type: string
    required: false
#  core-build-dir:
#    required: false
#    description: path to the core-universal binaries relative to repository root

runs:
  using: composite
  steps:
    - name: Get binaries
      working-directory: ${{inputs.working-directory}}
      shell: bash
      env:
        GH_TOKEN: ${{github.token}}
        JS_CORE_BIN: js/packages/core/bin
      run: |
        if [[ (-d "$JS_CORE_BIN") ]]; then
          echo "binaries path correct $JS_CORE_BIN ; using it"
          ls $JS_CORE_BIN
          tar -czf ./ruby/ext/eyes-universal/core.tar.gz $JS_CORE_BIN/core-*
          chmod +x $JS_CORE_BIN/core-linux
          $JS_CORE_BIN/core-linux --version
        else
          echo "no binaries in $JS_CORE_BIN ; using script"
          ./scripts/download-core-bin.sh --dir "./ruby/ext/eyes-universal"
          tar -czf ./ruby/ext/eyes-universal/core.tar.gz ./ruby/ext/eyes-universal/core-*
          chmod +x ./ruby/ext/eyes-universal/core-linux
          ./ruby/ext/eyes-universal/core-linux --version
        fi
    - name: Build Gems
      working-directory: ${{inputs.working-directory}}
      shell: bash
      env:
        GEMS: ${{ inputs.gem-list }}
      run: |
        echo $GEMS
        pwd

        cd ruby
        gem install builder
        rake clobber clean build
        cd pkg
        mkdir gems
        mv ./*.gem ./gems
        gem generate_index
