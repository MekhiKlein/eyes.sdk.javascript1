name: Ruby build
description: Build Ruby SDK Packages

inputs:
  working-directory:
    description: the path to the directory from repository root
    type: string
    required: true
  server-build:
    description: flag for js binaries
    type: boolean
    required: false

runs:
  using: composite
  steps:
    - name: Get binaries
      if: ${{inputs.server-build}}
      working-directory: .
      shell: bash
      env:
        GH_TOKEN: ${{github.token}}
        JS_CORE_BIN: js/packages/core/bin
      run: |
        if [[ (-d "$JS_CORE_BIN") ]]; then
          echo "binaries path correct $JS_CORE_BIN ; using it"
          ls $JS_CORE_BIN
          tar -czf ./ruby/eyes_universal/ext/eyes-universal/core.tar.gz $JS_CORE_BIN/core-*
          chmod +x $JS_CORE_BIN/core-linux
          $JS_CORE_BIN/core-linux --version
        else
          echo "no binaries in $JS_CORE_BIN ; using script"
          ./scripts/download-core-bin.sh --dir "./ruby/eyes_universal/ext/eyes-universal"
          tar -czf ./ruby/eyes_universal/ext/eyes-universal/core.tar.gz ./ruby/eyes_universal/ext/eyes-universal/core-*
          chmod +x ./ruby/eyes_universal/ext/eyes-universal/core-linux
          ./ruby/eyes_universal/ext/eyes-universal/core-linux --version
        fi

    - name: Get dependencies
      if: ${{inputs.working-directory == 'ruby/eyes_images' || inputs.working-directory == 'ruby/eyes_capybara'}}
      working-directory: ${{inputs.working-directory}}
      shell: bash
      run: |
        gem install builder rspec
    - name: Build Gems
      working-directory: ${{inputs.working-directory}}
      shell: bash
      run: |
        rake build
    - name: Prepare to serving gems statically
      working-directory: ${{inputs.working-directory}}
      shell: bash
      run: |
        mkdir -p ../pkg/gems
        mv pkg/*.gem ../pkg/gems
        cd ../pkg
        gem generate_index
