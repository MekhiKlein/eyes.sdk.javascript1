name: Publish

on:
  workflow_dispatch:
    inputs:
      packages:
        description: package names (aliases)
        required: true
      default-version:
        description: default version type
        type: choice
        options: [ patch, minor, major ]
        default: patch
      include-dependencies:
        description: include dependencies
        type: boolean
        default: true
      include-only-changed:
        description: include only packages with new commits
        type: boolean
        default: true

env:
  FORCE_COLOR: 3
  NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
  GITHUB_TOKEN: ${{secrets.RUN_GITHUB_TOKEN}}

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      packages: ${{steps.setup.outputs.packages}}
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup
        uses: ./.github/actions/parser
        id: setup
        with:
          packages: ${{github.event.inputs.packages}}
          include-only-changed: ${{github.event.inputs.include-only-changed}}
          include-dependencies: ${{github.event.inputs.include-dependencies}}
          default-publish-version: ${{github.event.inputs.default-version}}

  # INTERNAL
  utils:
    needs: [ setup ]
    if: ${{fromJSON(needs.setup.outputs.packages).utils && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).utils.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-utils.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).utils.params.version}}"}'
  logger:
    needs: [ setup, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).logger && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).logger.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-logger.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).logger.params.version}}"}'
  socket:
    needs: [ setup, logger, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).socket && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).socket.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-socket.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).socket.params.version}}"}'
  req:
    needs: [ setup, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).req && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).req.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-req.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).req.params.version}}"}'
  snippets:
    needs: [ setup ]
    if: ${{fromJSON(needs.setup.outputs.packages).snippets && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).snippets.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-snippets.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).snippets.params.version}}"}'
  image:
    needs: [ setup, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).image && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).image.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-image.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).image.params.version}}"}'
  screenshoter:
    needs:
      [
        setup,
        image,
        logger,
        snippets,
        utils,
        driver,
        spec-webdriverio,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).screenshoter && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).screenshoter.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-screenshoter.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).screenshoter.params.version}}"}'
  driver:
    needs: [ setup, logger, snippets, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).driver && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).driver.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-driver.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).driver.params.version}}"}'

  # TESTING BASE
  test-utils:
    needs: [ setup ]
    if: ${{fromJSON(needs.setup.outputs.packages).test-utils && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).test-utils.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-test-utils.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).test-utils.params.version}}"}'
  test-server:
    needs: [ setup, logger, utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).test-server && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).test-server.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-test-server.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).test-server.params.version}}"}'

  # CORE
  core-base:
    needs:
      [
        setup,
        image,
        logger,
        req,
        utils,
        test-server,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).core-base && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).core-base.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-core-base.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).core-base.params.version}}"}'
  core:
    needs:
      [
        setup,
        core-base,
        driver,
        ec-client,
        logger,
        nml-client,
        req,
        screenshoter,
        snippets,
        socket,
        spec-webdriver,
        ufg-client,
        utils,
        spec-puppeteer,
        spec-selenium,
        spec-webdriverio,
        test-server,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).core && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).core.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-core.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).core.params.version}}"}'
  ufg-client:
    needs: [ setup, logger, req, utils, test-server, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).ufg-client && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).ufg-client.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-ufg-client.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).ufg-client.params.version}}"}'
  ec-client:
    needs: [ setup, logger, req, socket, utils, test-server ]
    if: ${{fromJSON(needs.setup.outputs.packages).ec-client && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).ec-client.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-ec-client.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).ec-client.params.version}}"}'
  nml-client:
    needs:
      [
        setup,
        logger,
        req,
        utils,
        spec-webdriverio,
        test-server,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).nml-client && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).nml-client.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-nml-client.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).nml-client.params.version}}"}'
  api:
    needs: [ setup, core, logger, utils, req ]
    if: ${{fromJSON(needs.setup.outputs.packages).api && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).api.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-api.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).api.params.version}}"}'

  # SPEC DRIVERS
  spec-playwright:
    needs: [ setup, driver, utils, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).spec-playwright && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).spec-playwright.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-spec-playwright.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).spec-playwright.params.version}}"}'
  spec-puppeteer:
    needs: [ setup, driver, utils, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).spec-puppeteer && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).spec-puppeteer.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-spec-puppeteer.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).spec-puppeteer.params.version}}"}'
  spec-webdriver:
    needs: [ setup, driver, utils, test-server, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).spec-webdriver && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).spec-webdriver.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-spec-webdriver.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).spec-webdriver.params.version}}"}'
  spec-webdriverio:
    needs: [ setup, driver, utils, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).spec-webdriverio && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).spec-webdriverio.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-spec-webdriverio.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).spec-webdriverio.params.version}}"}'
  spec-selenium:
    needs: [ setup, driver, utils, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).spec-selenium && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).spec-selenium.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-spec-selenium.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).spec-selenium.params.version}}"}'

  # JS SDKS
  images:
    needs: [ setup, core, api, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).images && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).images.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-images.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).images.params.version}}"}'
  playwright:
    needs: [ setup, core, api, spec-playwright, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).playwright && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).playwright.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-playwright.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).playwright.params.version}}"}'
  puppeteer:
    needs: [ setup, core, api, spec-puppeteer, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).puppeteer && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).puppeteer.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-puppeteer.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).puppeteer.params.version}}"}'
  webdriverio:
    needs: [ setup, core, api, spec-webdriverio, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).webdriverio && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).webdriverio.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-webdriverio.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).webdriverio.params.version}}"}'
  selenium:
    needs: [ setup, core, api, spec-selenium, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).selenium && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).selenium.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-selenium.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).selenium.params.version}}"}'
  nightwatch:
    needs:
      [
        setup,
        core,
        driver,
        api,
        spec-webdriver,
        utils,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).nightwatch && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).nightwatch.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-nightwatch.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).nightwatch.params.version}}"}'
  testcafe:
    needs: [ setup, core, api, utils, test-server, test-utils ]
    if: ${{fromJSON(needs.setup.outputs.packages).testcafe && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).testcafe.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-testcafe.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).testcafe.params.version}}"}'
  cypress:
    needs:
      [
        setup,
        core,
        api,
        logger,
        utils,
        test-server,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).cypress && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).cypress.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-cypress.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).cypress.params.version}}"}'
  browser-extension:
    needs:
      [
        setup,
        core,
        driver,
        logger,
        screenshoter,
        utils,
        spec-playwright,
        test-utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).browser-extension && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).browser-extension.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-browser-extension.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).browser-extension.params.version}}"}'
  storybook:
    needs:
      [
        setup,
        core,
        driver,
        logger,
        spec-puppeteer,
        test-server,
        ufg-client,
        utils
      ]
    if: ${{fromJSON(needs.setup.outputs.packages).storybook && !failure() && !cancelled()}}
    name: ${{fromJSON(needs.setup.outputs.packages).storybook.displayName}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: publish-storybook.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).storybook.params.version}}"}'

  # PYTHON BINDING
  python-universal:
    needs: [ setup, core ]
    if: ${{fromJSON(needs.setup.outputs.packages).python-universal && !failure() && !cancelled()}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: py-publish.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).python-universal.version}}", "package": "${{fromJSON(needs.setup.outputs.packages).python-universal.dirname}}"}'

  # PYTHON
  python-selenium:
    needs: [ setup, python-universal ]
    if: ${{fromJSON(needs.setup.outputs.packages).python-selenium && !failure() && !cancelled()}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: py-publish.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).python-selenium.version}}", "package": "${{fromJSON(needs.setup.outputs.packages).python-selenium.dirname}}"}'
  python-robotframework:
    needs: [ setup, python-selenium ]
    if: ${{fromJSON(needs.setup.outputs.packages).python-robotframework && !failure() && !cancelled()}}
    runs-on: ubuntu-latest
    steps:
      - name: Check-out repository
        uses: actions/checkout@v3
      - name: Run remote workflow
        uses: ./.github/actions/run
        with:
          workflow: py-publish.yml
          inputs: '{"version": "${{fromJSON(needs.setup.outputs.packages).python-robotframework.version}}", "package": "${{fromJSON(needs.setup.outputs.packages).python-robotframework.dirname}}"}'
